include(ExternalProject)

set(MUQ_DEPENDS )
if( CLF_BUILT_BOOST )
  list(APPEND MUQ_DEPENDS BOOST)
endif()
if( CLF_BUILT_EIGEN3 )
  list(APPEND MUQ_DEPENDS EIGEN3)
endif()
if( CLF_BUILT_NLOPT )
  list(APPEND MUQ_DEPENDS NLOPT)
endif()
if( CLF_BUILT_HDF5 )
  list(APPEND MUQ_DEPENDS HDF5)
endif()

ExternalProject_Add(
  MUQ
    PREFIX ${CLF_EXTERNAL_INSTALL_DIR}/muq/
    GIT_REPOSITORY https://bitbucket.org/mituq/muq2/src/master/
    LOG_DOWNLOAD OFF
    LOG_UPDATE OFF
    LOG_PATCH OFF
    LOG_CONFIGURE OFF
    LOG_BUILD OFF
    LOG_INSTALL OFF
    LOG_TEST OFF
    DEPENDS ${MUQ_DEPENDS}
    CMAKE_ARGS -DCMAKE_INSTALL_PREFIX=${CLF_EXTERNAL_INSTALL_DIR}/muq/
    -DCMAKE_CXX_COMPILER=${CMAKE_CXX_COMPILER}
    -DCMAKE_C_COMPILER=${CMAKE_C_COMPILER}
    -DCMAKE_CXX_FLAGS=${CMAKE_CXX_FLAGS}
    -DMUQ_EIGEN3_DIR=${EIGEN3_INCLUDE_DIR}
    -DMUQ_BOOST_DIR=${CLF_BOOST_DIR}
    -DBOOST_INCLUDE_DIR=${BOOST_INCLUDE_DIRS}
    -DBOOST_SYSTEM_LIBRARY=${BOOST_SYSTEM_LIBRARY}
    -DBOOST_FILESYSTEM_LIBRARY=${BOOST_FILESYSTEM_LIBRARY}
    -DBOOST_GRAPH_LIBRARY=${BOOST_GRAPH_LIBRARY}
    -DMUQ_HDF5_DIR=${CLF_HDF5_DIR}
    -DMUQ_NLOPT_DIR=${CLF_NLOPT_DIR}
    -DHDF5_INCLUDE_DIR=${HDF5_INCLUDE_DIR}
    -DHDF5_LIBRARY=${HDF5_LIBRARY}
    -DHDF5HL_LIBRARY=${HDF5HL_LIBRARY}
    -DMUQ_NLOPT_DIR=${CLF_NLOPT_DIR}
    -DMUQ_ENABLEGROUP_DEFAULT=OFF
    -DMUQ_ENABLEGROUP_UTILITIES_HDF5=ON
    -DMUQ_ENABLEGROUP_APPROXIMATION_QUADRATURE=ON
    -DMUQ_ENABLEGROUP_MODELING_DISTRIBUTIONS=ON
    BUILD_COMMAND make -j5
    INSTALL_COMMAND make -j5 install
)

list(APPEND MUQ_INCLUDE_DIRS
  "${CLF_EXTERNAL_INSTALL_DIR}/muq/include"
  "${CLF_EXTERNAL_INSTALL_DIR}/muq/muq_external/include"
)

list(APPEND MUQ_LIBRARIES
  "${CLF_EXTERNAL_INSTALL_DIR}/muq/lib/${library_prefix}muqUtilities${shared_library_suffix}"
  "${CLF_EXTERNAL_INSTALL_DIR}/muq/lib/${library_prefix}muqModeling${shared_library_suffix}"
  "${CLF_EXTERNAL_INSTALL_DIR}/muq/lib/${library_prefix}muqApproximation${shared_library_suffix}"
)
